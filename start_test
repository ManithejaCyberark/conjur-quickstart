set +x

rm -rf .env
docker-compose down -v

docker-compose build

#generate Master key and load master key as env variable

docker-compose run --no-deps --rm conjur data-key generate > data_key

export CONJUR_DATA_KEY="$(< data_key)"

echo $CONJUR_DATA_KEY

echo " "
echo "*************"
echo "setting up the environment...... "
docker-compose up -d
docker-compose exec -T conjur conjurctl wait -r 240
echo "completed"
echo "enter 'docker ps' to see the running containers and docker ps -a to see all the running and stoped containers"
echo "*************"
echo " "
#admin_api_key
#docker-compose exec conjur conjurctl account create myConjurAccount > admin_data
#admin_api_key=$(docker-compose exec -T conjur conjurctl role retrieve-key myConjurAccount:user:admin | tr -d '\r')

#creating the account
echo " "
echo "***************"
echo "creating myConjurAccount and generating the api key and storing it at admin_api_key"
admin_api_key=$(docker-compose exec conjur conjurctl account create myConjurAccount | awk '/API key for admin/ {print $NF}'| tr '  \n\r' ' '|awk '{$1=$1};1')
export CONJUR_AUTHN_API_KEY=$admin_api_key
echo "${CONJUR_AUTHN_API_KEY}"
echo "created myConjurAccount"
echo "***************"

echo " "
echo " "
echo "****************"
echo " connecting to the conjur client and conjur server"
echo "****************"
echo "initiating myConjurAccount and logging in as a  admin user"
docker-compose exec client conjur init -u conjur -a myConjurAccount
echo " "
echo "****************"
echo "Log in to Conjur as admin"
echo " "
docker-compose exec client conjur authn login -u admin -p $CONJUR_AUTHN_API_KEY
echo ****************""
echo " "


#authn-jwt-jenkins configuration
echo "defining and loading the policies "
echo " "
echo "****************"
echo " authn-jwt-jenkins configuration"
echo "****************"
docker-compose exec client conjur policy load root policy/jwt/authn-jwt-jenkins.yml

echo "set the variable values"
echo "setting the jwks-uri"
docker-compose exec client conjur variable values add conjur/authn-jwt/jenkins/jwks-uri 'http://jenkins_server:8080/jwtauth/conjur-jwk-set'
echo "setting issuer"
docker-compose exec client conjur variable values add conjur/authn-jwt/jenkins/issuer 'http://localhost:8083'
echo "setting the audience"
docker-compose exec client conjur variable values add conjur/authn-jwt/jenkins/audience 'jenkins-server'
echo "setting the token-app-property"
docker-compose exec client conjur variable values add conjur/authn-jwt/jenkins/token-app-property 'jenkins_name'

echo "#############"
docker-compose exec client conjur list
echo "completed"
echo "##########"

#docker-compose exec client bash


#load policy/jenkins-projects.yml

echo "loading policy jenkins-projects.yml"
docker-compose exec client conjur policy load root policy/jwt/jenkins-projects.yml
echo "set the identity path"
docker-compose exec client conjur variable values add conjur/authn-jwt/jenkins/identity-path 'jenkins/projects'

#load policy/jenkins-secrets.yml
echo "loading secrets jenkins-secrets.yml"
docker-compose exec client conjur policy load root policy/jwt/jenkins-secrets.yml
docker-compose exec client conjur list




